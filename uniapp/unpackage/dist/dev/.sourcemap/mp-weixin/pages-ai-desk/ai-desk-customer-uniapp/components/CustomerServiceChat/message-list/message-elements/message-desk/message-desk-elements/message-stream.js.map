{"version":3,"file":"message-stream.js","sources":["pages-ai-desk/ai-desk-customer-uniapp/components/CustomerServiceChat/message-list/message-elements/message-desk/message-desk-elements/message-stream.vue","E:/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/RDovSkFWQUVFL215ZmxpZXMvdW5pYXBwLWFwcC91bmlhcHAvcGFnZXMtYWktZGVzay9haS1kZXNrLWN1c3RvbWVyLXVuaWFwcC9jb21wb25lbnRzL0N1c3RvbWVyU2VydmljZUNoYXQvbWVzc2FnZS1saXN0L21lc3NhZ2UtZWxlbWVudHMvbWVzc2FnZS1kZXNrL21lc3NhZ2UtZGVzay1lbGVtZW50cy9tZXNzYWdlLXN0cmVhbS52dWU"],"sourcesContent":["<template>\n  <div>\n    <div class=\"message-stream\">\n      <span v-if=\"isCursorBlinking\" class=\"blinking-cursor\">|</span>\n      <pre ref=\"preRef\" :class=\"['message-marked']\" v-html=\"displayedContent\" @click=\"onPreClicked\"/>\n    </div>\n    <div v-if=\"image\" class=\"markdown-image-previewer\" @click=\"closeImage\">\n      <img\n          class=\"markdown-image\"\n          :src=\"imageSrc\"\n      />\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport vue from '../../../../../../adapter-vue';\nimport { customerServicePayloadType } from '../../../../../../interface';\nimport { parseMarkdown } from './marked';\nimport { TypeWriter } from './type-writer';\nimport { JSONToObject } from \"../../../../../../utils\";\nimport { isWeChat, isPC, isH5 } from \"../../../../../../utils/env\";\nimport { StoreName, TUIStore } from '@tencentcloud/chat-uikit-engine';\nimport { isVue3App } from \"../../../../../../utils/utils\";\n\nconst { ref, computed, withDefaults, defineProps, watch, onMounted, onUnmounted } = vue;\n\ninterface Props {\n  payload: customerServicePayloadType;\n  messageID: string;\n}\n\nconst props = withDefaults(defineProps<Props>(), {\n  payload: () => ({} as customerServicePayloadType),\n  messageID: '',\n});\n\nconst isCursorBlinking = ref<boolean>(true);\nconst isStreaming = ref<boolean>(false);\nconst image = ref(false);\nconst imageSrc = ref('');\nconst chunks = ref<string>('');\nconst isFinished = ref<boolean>(true);\nconst prevChunksLength = ref<number>(0);\nconst streamContent = ref<string>('');\nconst displayedContent = ref<string>('');\nconst preRef = ref();\nconst emits = defineEmits(['heightChanged']);\n// uni-app 的 js 运行时版本太低，不支持 ResizeObserver 和 MutationObserver\nconst canIUseResizeObserver = typeof ResizeObserver === 'undefined' ? false : true;\nconst messageID = ref<string>('');\n\nlet observer;\nlet prevHeight = 0;\nlet count = 0;\n\nconst typeWriter = new TypeWriter({\n  onTyping: (item: string) => {\n    streamContent.value += item;\n    displayedContent.value = parseMarkdown(streamContent.value);\n  },\n  onComplete() {\n    isStreaming.value = false;\n  },\n});\n\nfunction startStreaming(content: string[]) {\n  if (!isStreaming.value) {\n    isStreaming.value = true;\n    typeWriter.add(content);\n    typeWriter.start();\n  } else {\n    typeWriter.add(content);\n  }\n}\n\nwatch(() => props.payload, (newValue: string, oldValue: string) => {\n      if (newValue === oldValue) {\n        return;\n      }\n\n      const _payloadObject = JSONToObject(props.payload);\n      chunks.value = Array.isArray(_payloadObject.chunks) ? _payloadObject.chunks.join('') : _payloadObject.chunks;\n      isFinished.value = _payloadObject.isFinished === 1;\n\n      // hide blinking cursor\n      if (chunks.value.length > 0) {\n        isCursorBlinking.value = false;\n      }\n\n      if (isWeChat || (newValue && !oldValue && isFinished.value)) {\n        streamContent.value = chunks.value;\n        prevChunksLength.value = chunks.value.length;\n        displayedContent.value = parseMarkdown(streamContent.value);\n      } else {\n        // 判断长度是为了防御编辑的内容回退和内容重复的异常 case\n        if (chunks.value.length > prevChunksLength.value) {\n          const _newChunksToAdd = chunks.value?.slice(prevChunksLength.value);\n          prevChunksLength.value = chunks.value.length;\n          startStreaming([_newChunksToAdd]);\n        }\n      }\n    }, {\n      deep: true,\n      immediate: true,\n    },\n);\n\nconst onHackedMessageID = (data: string) => {\n  if (data !== messageID.value || isFinished.value) {\n    return;\n  }\n\n  const message = TUIStore.getMessageModel(data);\n  if (!message) {\n    return;\n  }\n  if (message.payload.data) {\n    const obj = JSONToObject(message.payload.data);\n    const chunk2String = Array.isArray(obj.chunks) ? obj.chunks.join('') : obj.chunks;\n    if (chunk2String !== streamContent.value) {\n      streamContent.value = chunk2String;\n      prevChunksLength.value = chunk2String.length;\n      displayedContent.value = parseMarkdown(streamContent.value);\n    }\n    if (chunk2String.length > 0) {\n      isCursorBlinking.value = false;\n    }\n    isFinished.value = obj.isFinished;\n  }\n}\n\nonMounted(() => {\n  messageID.value = props.messageID;\n  TUIStore.watch(StoreName.CUSTOM, {\n    'hackedMessageID': onHackedMessageID,\n  });\n\n  if (canIUseResizeObserver) {\n    observer = new ResizeObserver(entries => {\n      for (let entry of entries) {\n        observeHeightChanged(entry.contentRect.height);\n      }\n    });\n    // 开始观察\n    observer.observe(preRef.value);\n  } else if (isVue3App) {\n    // vue2->app，可能会出现未知的错误，下面代码仅 vue3->app 运行\n    observer = setInterval(() => {\n      const query = uni.createSelectorQuery().in(this);\n      // 注意！用 ID 选择器经测试无效。。。得用 class 选择器\n      query.selectAll(\".message-stream\")\n          .boundingClientRect((res) => {\n            if (res.length >= 1) {\n              const data = res[res.length - 1];\n              observeHeightChanged(data.height);\n            }\n          })\n          .exec();\n    }, 100);\n  }\n});\n\nonUnmounted(() => {\n  TUIStore.unwatch(StoreName.CUSTOM, {\n    'hackedMessageID': onHackedMessageID,\n  });\n\n  if (canIUseResizeObserver) {\n    if (observer) {\n      observer.disconnect();\n      observer = null;\n    }\n  } else {\n    clearTimer();\n  }\n});\n\nconst observeHeightChanged = (newHeight) => {\n  if (prevHeight !== newHeight) {\n    prevHeight = newHeight;\n    emits('heightChanged');\n  } else if (!canIUseResizeObserver) {\n    // 过了8秒高度没变化，就认为加载完了，清空定时器\n    count += 1;\n    if (count >= 80) {\n      clearTimer();\n    }\n  }\n};\n\nconst clearTimer = () => {\n  clearInterval(observer);\n  prevHeight = 0;\n  count = 0;\n};\n\nconst closeImage = () => {\n  image.value = !image.value;\n  imageSrc.value = '';\n};\n\nconst onPreClicked = (event) => {\n  // web 环境支持预览图文混排的图片；app 和小程序暂不支持\n  if (isPC || isH5) {\n    const target = event.target;\n    const tagName = event.target.tagName.toLowerCase();\n    if (tagName === 'img' || tagName === 'image') {\n      image.value = true;\n      imageSrc.value = target.src;\n    }\n  }\n};\n\n</script>\n<style lang=\"scss\" scoped>\n.message-stream {\n  overflow-wrap: break-word;\n  word-break: keep-all;\n  white-space: normal;\n  font-size: 14px;\n}\n\n.blinking-cursor {\n  animation: blink 0.8s step-end infinite;\n  color: #000;\n}\n\n@keyframes blink {\n  from, to { opacity: 1; }\n  50% { opacity: 0; }\n}\n\n.message-marked {\n  overflow: hidden;\n  word-break: break-word;\n  white-space: normal;\n  display: flex;\n  flex-direction: column;\n  justify-content: flex-start;\n  margin: 0;\n  padding: 0;\n  font-family: PingFangSC-Regular;\n\n  .message-marked_code-container {\n    display: flex;\n    flex-direction: column;\n    justify-content: flex-start;\n    border-radius: 9px;\n    margin: 0 0 10px;\n    padding: 1em;\n    overflow: hidden;\n  }\n\n  .message-marked_code-header {\n    display: flex;\n    justify-content: space-between;\n  }\n\n  .message-marked_code-content {\n    overflow: auto;\n  }\n\n  body, div, ul, ol, dt, dd, li, dl, h1, h2, h3, h4, p {\n    margin: 0 0 1em;\n  }\n\n  ul,ol,li {\n    list-style: disc;\n    list-style-type: disc;\n  }\n\n  ul,ol {\n    padding-left: 40px;\n    display: flex;\n    flex-direction: column;\n    justify-content: flex-start;\n  }\n\n  li {\n    padding: 0 0 5px;\n    margin: 0;\n  }\n\n  img {\n    overflow: hidden;\n    object-fit: contain;\n    max-width: 100%;\n  }\n\n  a {\n    color: #0052d9;\n    cursor: pointer;\n  }\n}\n\n.markdown-image-previewer {\n  position: fixed;\n  z-index: 101;\n  width: 100vw;\n  height: 100vh;\n  background: rgba(#000, 0.8);\n  top: 0;\n  left: 0;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  user-select: none;\n}\n\n.markdown-image {\n  max-width: 90%;\n  height: auto;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  overflow: hidden;\n}\n</style>\n","import Component from 'D:/JAVAEE/myflies/uniapp-app/uniapp/pages-ai-desk/ai-desk-customer-uniapp/components/CustomerServiceChat/message-list/message-elements/message-desk/message-desk-elements/message-stream.vue'\nwx.createComponent(Component)"],"names":["vue","TypeWriter","parseMarkdown","JSONToObject","isWeChat","TUIStore","StoreName","isVue3App","uni","isPC","isH5"],"mappings":"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"}