{"version":3,"file":"utils.js","sources":["pages-ai-desk/ai-desk-customer-uniapp/utils/utils.ts"],"sourcesContent":["import TUIChatEngine, {\n  TUITranslateService,\n  TUIStore,\n  StoreName,\n  IMessageModel,\n  TUIUserService,\n  IConversationModel,\n} from '@tencentcloud/chat-uikit-engine';\nimport {isApp} from \"./env\";\nimport {vueVersion} from \"../adapter-vue-uniapp\";\nimport {JSONToObject} from \"./index\";\nimport {CUSTOM_MESSAGE_SRC} from \"../constant\";\nimport Log from './logger';\n\nexport function deepCopy(data: any, hash = new WeakMap()) {\n  if (typeof data !== 'object' || data === null || data === undefined) {\n    return data;\n  }\n  if (hash.has(data)) {\n    return hash.get(data);\n  }\n  const newData: any = Object.create(Object.getPrototypeOf(data));\n  const dataKeys = Object.keys(data);\n  dataKeys.forEach((value) => {\n    const currentDataValue = data[value];\n    if (typeof currentDataValue !== 'object' || currentDataValue === null) {\n      newData[value] = currentDataValue;\n    } else if (Array.isArray(currentDataValue)) {\n      newData[value] = [...currentDataValue];\n    } else if (currentDataValue instanceof Set) {\n      newData[value] = new Set([...currentDataValue]);\n    } else if (currentDataValue instanceof Map) {\n      newData[value] = new Map([...currentDataValue]);\n    } else {\n      hash.set(data, data);\n      newData[value] = deepCopy(currentDataValue, hash);\n    }\n  });\n  return newData;\n}\n\nexport const handleSkeletonSize = (\n  width: number,\n  height: number,\n  maxWidth: number,\n  maxHeight: number,\n): { width: number; height: number } => {\n  const widthToHeight = width / height;\n  const maxWidthToHeight = maxWidth / maxHeight;\n  if (width <= maxWidth && height <= maxHeight) {\n    return { width, height };\n  }\n  if (\n    (width <= maxWidth && height > maxHeight)\n    || (width > maxWidth && height > maxHeight && widthToHeight <= maxWidthToHeight)\n  ) {\n    return { width: width * (maxHeight / height), height: maxHeight };\n  }\n  return { width: maxWidth, height: height * (maxWidth / width) };\n};\n\n// Image loading complete\nexport function getImgLoad(container: any, className: string, callback: any) {\n  const images = container?.querySelectorAll(`.${className}`) || [];\n  const promiseList = Array.prototype.slice.call(images).map((node: any) => {\n    return new Promise((resolve: any) => {\n      node.onload = () => {\n        resolve(node);\n      };\n      node.onloadeddata = () => {\n        resolve(node);\n      };\n      node.onprogress = () => {\n        resolve(node);\n      };\n      if (node.complete) {\n        resolve(node);\n      }\n    });\n  });\n  return Promise.all(promiseList)\n    .then(() => {\n      callback && callback();\n    })\n    .catch((e) => {\n      console.error('网络异常', e);\n    });\n}\n\nexport const isCreateGroupCustomMessage = (message: IMessageModel) => {\n  return (\n    message.type === TUIChatEngine.TYPES.MSG_CUSTOM\n    && message?.getMessageContent()?.businessID === 'group_create'\n  );\n};\n\n/**\n * displayMessageReadReceipt: User-level control to display message read status\n * After turning off, the messages you send and receive will not have message read status\n * You will not be able to see whether the other party has read their messages, and they will also not be able to see whether you have read the messages they sent\n *\n * enabledMessageReadReceipt: App-level setting to enable read receipts\n * @return {boolean} - Returns a boolean value indicating if the message read receipt is enabled globally.\n */\nexport function isEnabledMessageReadReceiptGlobal(): boolean {\n  return TUIStore.getData(StoreName.USER, 'displayMessageReadReceipt')\n    && TUIStore.getData(StoreName.APP, 'enabledMessageReadReceipt');\n}\n\nexport function shallowCopyMessage(message: IMessageModel) {\n  return Object.assign({}, message);\n}\n\n// calculate timestamp\nexport function calculateTimestamp(timestamp: number): string {\n  const todayZero = new Date().setHours(0, 0, 0, 0);\n  const thisYear = new Date(\n    new Date().getFullYear(),\n    0,\n    1,\n    0,\n    0,\n    0,\n    0,\n  ).getTime();\n  const target = new Date(timestamp);\n\n  const oneDay = 24 * 60 * 60 * 1000;\n  const oneWeek = 7 * oneDay;\n\n  const diff = todayZero - target.getTime();\n\n  function formatNum(num: number): string {\n    return num < 10 ? '0' + num : num.toString();\n  }\n\n  if (diff <= 0) {\n    // today, only display hour:minute\n    return `${formatNum(target.getHours())}:${formatNum(target.getMinutes())}`;\n  } else if (diff <= oneDay) {\n    // yesterday, display yesterday:hour:minute\n    return `${TUITranslateService.t('Time.昨天')} ${formatNum(\n      target.getHours(),\n    )}:${formatNum(target.getMinutes())}`;\n  } else if (diff <= oneWeek - oneDay) {\n    // Within a week, display weekday hour:minute\n    const weekdays = [\n      '星期日',\n      '星期一',\n      '星期二',\n      '星期三',\n      '星期四',\n      '星期五',\n      '星期六',\n    ];\n    const weekday = weekdays[target.getDay()];\n    return `${TUITranslateService.t('Time.' + weekday)} ${formatNum(\n      target.getHours(),\n    )}:${formatNum(target.getMinutes())}`;\n  } else if (target.getTime() >= thisYear) {\n    // Over a week, within this year, display mouth/day hour:minute\n    return `${target.getMonth() + 1}/${target.getDate()} ${formatNum(\n      target.getHours(),\n    )}:${formatNum(target.getMinutes())}`;\n  } else {\n    // Not within this year, display year/mouth/day hour:minute\n    return `${target.getFullYear()}/${\n      target.getMonth() + 1\n    }/${target.getDate()} ${formatNum(target.getHours())}:${formatNum(\n      target.getMinutes(),\n    )}`;\n  }\n}\n\nexport const isVue2App = isApp && vueVersion === 2;\n\nexport const isVue3App = isApp && vueVersion === 3;\n\n// uniapp vue2 uikit 打包 app ，流式消息的兼容逻辑，\n// 通过自实现响应式更新，解决 vue 追踪不到属性变更问题\nexport const needHackForStreamText = (data: string) => {\n  if (isVue2App && JSONToObject(data).src === CUSTOM_MESSAGE_SRC.STREAM_TEXT) {\n    return true;\n  }\n  return false;\n}\n\nexport function getSafeUrl(url) {\n  try {\n    const decodedUrl = decodeURIComponent(url);\n    // uni-app 打包 App 后，URL 不可用\n    if (typeof URL !== 'undefined') {\n      const parsedUrl = new URL(decodedUrl);\n      if (!['http:', 'https:'].includes(parsedUrl.protocol)) {\n        return null;\n      }\n\n      // 清除 username 和 password\n      parsedUrl.username = '';\n      parsedUrl.password = '';\n      return parsedUrl.href;\n    }\n    return decodedUrl;\n  } catch (e) {\n    return null;\n  }\n}\n\nexport function openSafeUrl(content: string) {\n  const safeUrl = getSafeUrl(content);\n  if (safeUrl) {\n    if (isApp) {\n      // #ifdef APP-PLUS\n      // @ts-ignore\n      plus.runtime.openURL(safeUrl);\n      // #endif\n    } else {\n      window.open(safeUrl, '_blank', 'noopener,noreferrer');\n    }\n  } else {\n    Log.w(`Invalid URL provided:${content}`);\n  }\n}\n\n// call after chat engine is ready\nexport function switchReadStatus(value: number) {\n  if (value !== 1) {\n    TUIUserService.switchMessageReadStatus(false);\n  } else {\n    TUIUserService.switchMessageReadStatus(true);\n  }\n}\n\nexport function getTo(conversation: IConversationModel): string {\n  return conversation?.groupProfile?.groupID || conversation?.userProfile?.userID;\n}\n"],"names":["TUIStore","StoreName","TUITranslateService","isApp","vueVersion","JSONToObject","CUSTOM_MESSAGE_SRC","Log","TUIUserService"],"mappings":";;;;;;;AAcO,SAAS,SAAS,MAAW,OAAO,oBAAI,WAAW;AACxD,MAAI,OAAO,SAAS,YAAY,SAAS,QAAQ,SAAS,QAAW;AAC5D,WAAA;AAAA,EACT;AACI,MAAA,KAAK,IAAI,IAAI,GAAG;AACX,WAAA,KAAK,IAAI,IAAI;AAAA,EACtB;AACA,QAAM,UAAe,OAAO,OAAO,OAAO,eAAe,IAAI,CAAC;AACxD,QAAA,WAAW,OAAO,KAAK,IAAI;AACxB,WAAA,QAAQ,CAAC,UAAU;AACpB,UAAA,mBAAmB,KAAK,KAAK;AACnC,QAAI,OAAO,qBAAqB,YAAY,qBAAqB,MAAM;AACrE,cAAQ,KAAK,IAAI;AAAA,IACR,WAAA,MAAM,QAAQ,gBAAgB,GAAG;AAC1C,cAAQ,KAAK,IAAI,CAAC,GAAG,gBAAgB;AAAA,IAAA,WAC5B,4BAA4B,KAAK;AAC1C,cAAQ,KAAK,IAAI,oBAAI,IAAI,CAAC,GAAG,gBAAgB,CAAC;AAAA,IAAA,WACrC,4BAA4B,KAAK;AAC1C,cAAQ,KAAK,IAAI,IAAI,IAAI,CAAC,GAAG,gBAAgB,CAAC;AAAA,IAAA,OACzC;AACA,WAAA,IAAI,MAAM,IAAI;AACnB,cAAQ,KAAK,IAAI,SAAS,kBAAkB,IAAI;AAAA,IAClD;AAAA,EAAA,CACD;AACM,SAAA;AACT;AAiEO,SAAS,oCAA6C;AACpD,SAAAA,iBAAS,QAAQC,cAAA,IAAU,MAAM,2BAA2B,KAC9DD,cAAS,GAAA,QAAQC,cAAAA,IAAU,KAAK,2BAA2B;AAClE;AAEO,SAAS,mBAAmB,SAAwB;AACzD,SAAO,OAAO,OAAO,CAAC,GAAG,OAAO;AAClC;AAGO,SAAS,mBAAmB,WAA2B;AACtD,QAAA,iCAAgB,QAAO,SAAS,GAAG,GAAG,GAAG,CAAC;AAChD,QAAM,WAAW,IAAI;AAAA,KACnB,oBAAI,KAAK,GAAE,YAAY;AAAA,IACvB;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA,QAAQ;AACJ,QAAA,SAAS,IAAI,KAAK,SAAS;AAE3B,QAAA,SAAS,KAAK,KAAK,KAAK;AAC9B,QAAM,UAAU,IAAI;AAEd,QAAA,OAAO,YAAY,OAAO,QAAQ;AAExC,WAAS,UAAU,KAAqB;AACtC,WAAO,MAAM,KAAK,MAAM,MAAM,IAAI;EACpC;AAEA,MAAI,QAAQ,GAAG;AAEN,WAAA,GAAG,UAAU,OAAO,SAAS,CAAC,CAAC,IAAI,UAAU,OAAO,WAAY,CAAA,CAAC;AAAA,EAAA,WAC/D,QAAQ,QAAQ;AAEzB,WAAO,GAAGC,cAAAA,GAAoB,EAAE,SAAS,CAAC,IAAI;AAAA,MAC5C,OAAO,SAAS;AAAA,IAAA,CACjB,IAAI,UAAU,OAAO,WAAY,CAAA,CAAC;AAAA,EAAA,WAC1B,QAAQ,UAAU,QAAQ;AAEnC,UAAM,WAAW;AAAA,MACf;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA;AAEF,UAAM,UAAU,SAAS,OAAO,OAAQ,CAAA;AACxC,WAAO,GAAGA,cAAAA,GAAoB,EAAE,UAAU,OAAO,CAAC,IAAI;AAAA,MACpD,OAAO,SAAS;AAAA,IAAA,CACjB,IAAI,UAAU,OAAO,WAAY,CAAA,CAAC;AAAA,EAC1B,WAAA,OAAO,QAAQ,KAAK,UAAU;AAEhC,WAAA,GAAG,OAAO,aAAa,CAAC,IAAI,OAAO,SAAS,IAAI;AAAA,MACrD,OAAO,SAAS;AAAA,IAAA,CACjB,IAAI,UAAU,OAAO,WAAY,CAAA,CAAC;AAAA,EAAA,OAC9B;AAEL,WAAO,GAAG,OAAO,YAAa,CAAA,IAC5B,OAAO,SAAa,IAAA,CACtB,IAAI,OAAO,QAAA,CAAS,IAAI,UAAU,OAAO,SAAU,CAAA,CAAC,IAAI;AAAA,MACtD,OAAO,WAAW;AAAA,IACnB,CAAA;AAAA,EACH;AACF;AAEa,MAAA,YAAYC,2CAAAA,SAASC,kDAAe,eAAA;AAEpC,MAAA,YAAYD,2CAAAA,SAASC,kDAAAA,eAAe;AAIpC,MAAA,wBAAwB,CAAC,SAAiB;AACrD,MAAI,aAAaC,6CAAAA,aAAa,IAAI,EAAE,QAAQC,6DAAmB,aAAa;AACnE,WAAA;AAAA,EACT;AACO,SAAA;AACT;AAEO,SAAS,WAAW,KAAK;AAC1B,MAAA;AACI,UAAA,aAAa,mBAAmB,GAAG;AAErC,QAAA,OAAO,QAAQ,aAAa;AACxB,YAAA,YAAY,IAAI,IAAI,UAAU;AAChC,UAAA,CAAC,CAAC,SAAS,QAAQ,EAAE,SAAS,UAAU,QAAQ,GAAG;AAC9C,eAAA;AAAA,MACT;AAGA,gBAAU,WAAW;AACrB,gBAAU,WAAW;AACrB,aAAO,UAAU;AAAA,IACnB;AACO,WAAA;AAAA,WACA,GAAG;AACH,WAAA;AAAA,EACT;AACF;AAEO,SAAS,YAAY,SAAiB;AACrC,QAAA,UAAU,WAAW,OAAO;AAClC,MAAI,SAAS;AACX,QAAIH,2CAAAA;AAAO;AAAA,SAKJ;AACE,aAAA,KAAK,SAAS,UAAU,qBAAqB;AAAA,IACtD;AAAA,EAAA,OACK;AACDI,kDAAAA,IAAA,EAAE,wBAAwB,OAAO,EAAE;AAAA,EACzC;AACF;AAGO,SAAS,iBAAiB,OAAe;AAC9C,MAAI,UAAU,GAAG;AACfC,qBAAe,wBAAwB,KAAK;AAAA,EAAA,OACvC;AACLA,qBAAe,wBAAwB,IAAI;AAAA,EAC7C;AACF;AAEO,SAAS,MAAM,cAA0C;;AAC9D,WAAO,kDAAc,iBAAd,mBAA4B,cAAW,kDAAc,gBAAd,mBAA2B;AAC3E;;;;;;;;;;"}