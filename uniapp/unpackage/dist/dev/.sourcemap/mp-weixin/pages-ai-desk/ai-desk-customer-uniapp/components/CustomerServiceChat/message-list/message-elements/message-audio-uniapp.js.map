{"version":3,"file":"message-audio-uniapp.js","sources":["pages-ai-desk/ai-desk-customer-uniapp/components/CustomerServiceChat/message-list/message-elements/message-audio-uniapp.vue","E:/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/RDovSkFWQUVFL215ZmxpZXMvdW5pYXBwLWFwcC91bmlhcHAvcGFnZXMtYWktZGVzay9haS1kZXNrLWN1c3RvbWVyLXVuaWFwcC9jb21wb25lbnRzL0N1c3RvbWVyU2VydmljZUNoYXQvbWVzc2FnZS1saXN0L21lc3NhZ2UtZWxlbWVudHMvbWVzc2FnZS1hdWRpby11bmlhcHAudnVl"],"sourcesContent":["<template>\n  <div\n    :class=\"{\n      'message-audio': true,\n      reserve: props.messageItem.flow === 'out',\n    }\"\n    @click=\"toggleClick\"\n  >\n    <div class=\"audio-icon-container\">\n      <!-- <div :class=\"{ mask: true, play: isAudioPlaying }\" /> -->\n      <Icon\n        :class=\"{icon:true,play: isAudioPlaying}\"\n        width=\"15px\"\n        height=\"20px\"\n        :file=\"audioIcon\"\n      />\n    </div>\n    <div\n      class=\"time\"\n      :style=\"{ width: `${props.content.second * 5}px` }\"\n    >\n      {{ props.content.second || 1 }} \"\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport vue from '../../../../adapter-vue';\nimport { IMessageModel } from '@tencentcloud/chat-uikit-engine';\nimport Icon from '../../../common/Icon.vue';\nimport { Toast } from '../../../common/Toast/index-uniapp';\nimport audioIcon from '../../../../assets/msg-audio.svg';\nimport { IAudioMessageContent, IAudioContext } from '../../../../interface';\nconst { onUnmounted, ref, watch } = vue;\n\ninterface IProps {\n  broadcastNewAudioSrc: string;\n  messageItem: IMessageModel;\n  content: IAudioMessageContent;\n}\n\ninterface IEmits {\n  (\n    e: 'getGlobalAudioContext',\n    map: Map<string, IAudioContext>,\n    options?: { newAudioSrc: string }\n  ): void;\n  (e: 'setAudioPlayed', messageID: string): void;\n}\n\nconst emits = defineEmits<IEmits>();\nconst props = withDefaults(defineProps<IProps>(), {\n  messageItem: () => ({} as IMessageModel),\n  content: () => ({} as IAudioMessageContent),\n});\n\nconst audioMap = new Map<string, IAudioContext>();\nconst isAudioPlaying = ref<boolean>(false);\n\nonUnmounted(() => {\n  const audioContext = getAudio();\n  if (isAudioPlaying.value) {\n    stopAudio();\n  }\n  audioContext?.destroy?.();\n  audioMap.delete('audio');\n});\n\nwatch(\n  () => props.broadcastNewAudioSrc,\n  (newSrc) => {\n    if (newSrc !== props.content.url && isAudioPlaying.value) {\n      stopAudio();\n      // The audioContext may have been destroyed. Manually execute the pause\n      isAudioPlaying.value = false;\n    }\n  },\n);\n\nfunction toggleClick() {\n  emits('getGlobalAudioContext', audioMap, { newAudioSrc: props.content.url });\n  if (props.messageItem.hasRiskContent || !props.content.url) {\n    Toast({\n      message: '暂不支持播放',\n    });\n    return;\n  }\n  // audioContext will be cached, it must be get first\n  const audioContext = getAudio();\n  if (!audioContext) {\n    audioMap.set('audio', uni.createInnerAudioContext() as IAudioContext);\n\n    uni.setInnerAudioOption({\n      obeyMuteSwitch: false,\n    });\n\n    initAudioSrc();\n  }\n  toggleAudioPlayState();\n}\n\nfunction toggleAudioPlayState() {\n  if (!isAudioPlaying.value) {\n    playAudio();\n  } else {\n    stopAudio();\n  }\n}\n\nfunction initAudioSrc() {\n  const audioContext = getAudio();\n  if (!audioContext) {\n    return;\n  }\n  audioContext.src = props.content.url;\n  isAudioPlaying.value = false;\n  audioContext.onPlay(onAudioPlay);\n  audioContext.onStop(onAudioStop);\n  audioContext.onEnded(onAudioEnded);\n  audioContext.onError(onAudioError);\n}\n\nfunction playAudio() {\n  const audioContext = getAudio();\n  if (!audioContext) {\n    return;\n  }\n  audioContext.play();\n  if (props.messageItem.flow === 'in') {\n    emits('setAudioPlayed', props.messageItem.ID);\n  }\n}\n\nfunction stopAudio() {\n  const audioContext = getAudio();\n  if (!audioContext) {\n    return;\n  }\n  try {\n    // The memory of the audiocontext is in memory. But The play instance may have been destroyed.\n    audioContext.stop();\n  } catch {\n    // ignore\n  }\n}\n\nfunction onAudioPlay() {\n  isAudioPlaying.value = true;\n}\n\nfunction onAudioStop() {\n  isAudioPlaying.value = false;\n}\n\nfunction onAudioEnded() {\n  isAudioPlaying.value = false;\n}\n\nfunction onAudioError() {\n  uni.__f__('warn','at pages-ai-desk/ai-desk-customer-uniapp/components/CustomerServiceChat/message-list/message-elements/message-audio-uniapp.vue:160','audio played error');\n}\n\nfunction getAudio(): IAudioContext | undefined {\n  return audioMap.get('audio');\n}\n</script>\n\n<style lang=\"scss\" scoped>\n$flow-in-bg-color: #fbfbfb;\n$flow-out-bg-color: #dceafd;\n\n@keyframes audio-play {\n  0% {\n    transform: scaleX(0.7056);\n  }\n\n  50% {\n    transform: scaleX(0.3953);\n  }\n\n  75% {\n    transform: scaleX(0);\n    visibility: hidden;\n  }\n\n  100% {\n    transform: scaleX(0);\n    visibility: hidden;\n  }\n}\n\n\n:not(not) {\n  display: flex;\n  flex-direction: column;\n  box-sizing: border-box;\n  min-width: 0;\n}\n\n.message-audio {\n  flex-direction: row;\n  flex: 0 0 auto;\n  cursor: pointer;\n  -webkit-tap-highlight-color: transparent;\n  overflow: hidden;\n\n  .audio-icon-container {\n    width: 16px;\n    height: 20px;\n    position: relative;\n    flex: 0 0 auto;\n    flex-direction: row;\n    justify-content: flex-end;\n    margin: 0 7px 0 0;\n    overflow: hidden;\n\n    .mask {\n      position: absolute;\n      z-index: 1;\n      width: 105%;\n      height: 105%;\n      left: 0;\n      top: 0;\n      transform-origin: right;\n      transform: scaleX(0);\n      background-color: $flow-in-bg-color;\n\n      &.play {\n        animation: audio-play 2s steps(1, end) infinite;\n      }\n    }\n    .icon{\n      &.play{\n      animation: blink 1s infinite;\n    }\n    } \n  }\n\n  @keyframes audio-play {\n    0% {\n      transform: scaleX(0.7056);\n    }\n\n    50% {\n      transform: scaleX(0.3953);\n    }\n\n    75% {\n      transform: scaleX(0);\n      visibility: hidden;\n    }\n\n    100% {\n      transform: scaleX(0);\n      visibility: hidden;\n    }\n  }\n\n  .time {\n    max-width: 165px;\n    min-width: 20px;\n    text-align: start;\n    white-space: nowrap;\n  }\n\n  &.reserve {\n    flex-direction: row-reverse;\n\n    .time {\n      text-align: end;\n    }\n\n    .audio-icon-container {\n      margin: 0 0 0 7px;\n\n      .mask {\n        transform-origin: left;\n        background-color: $flow-out-bg-color;\n      }\n    }\n\n    .icon {\n      transform: rotate(180deg);\n    }\n  }\n}\n</style>\n","import Component from 'D:/JAVAEE/myflies/uniapp-app/uniapp/pages-ai-desk/ai-desk-customer-uniapp/components/CustomerServiceChat/message-list/message-elements/message-audio-uniapp.vue'\nwx.createComponent(Component)"],"names":["vue","Toast","uni"],"mappings":";;;;;;;;AA6BA,MAAA,OAAiB,MAAA;;;;;;;;;;AAIjB,UAAM,EAAE,aAAa,KAAK,MAAA,IAAUA,4CAAAA;AAiBpC,UAAM,QAAQ;AACd,UAAM,QAAQ;AAKR,UAAA,+BAAe;AACf,UAAA,iBAAiB,IAAa,KAAK;AAEzC,gBAAY,MAAM;;AAChB,YAAM,eAAe;AACrB,UAAI,eAAe,OAAO;AACd;MACZ;AACA,yDAAc,YAAd;AACA,eAAS,OAAO,OAAO;AAAA,IAAA,CACxB;AAED;AAAA,MACE,MAAM,MAAM;AAAA,MACZ,CAAC,WAAW;AACV,YAAI,WAAW,MAAM,QAAQ,OAAO,eAAe,OAAO;AAC9C;AAEV,yBAAe,QAAQ;AAAA,QACzB;AAAA,MACF;AAAA,IAAA;AAGF,aAAS,cAAc;AACrB,YAAM,yBAAyB,UAAU,EAAE,aAAa,MAAM,QAAQ,KAAK;AAC3E,UAAI,MAAM,YAAY,kBAAkB,CAAC,MAAM,QAAQ,KAAK;AACpDC,mFAAA;AAAA,UACJ,SAAS;AAAA,QAAA,CACV;AACD;AAAA,MACF;AAEA,YAAM,eAAe;AACrB,UAAI,CAAC,cAAc;AACjB,iBAAS,IAAI,SAASC,cAAAA,MAAI,wBAA0C,CAAA;AAEpEA,sBAAAA,MAAI,oBAAoB;AAAA,UACtB,gBAAgB;AAAA,QAAA,CACjB;AAEY;MACf;AACqB;IACvB;AAEA,aAAS,uBAAuB;AAC1B,UAAA,CAAC,eAAe,OAAO;AACf;MAAA,OACL;AACK;MACZ;AAAA,IACF;AAEA,aAAS,eAAe;AACtB,YAAM,eAAe;AACrB,UAAI,CAAC,cAAc;AACjB;AAAA,MACF;AACa,mBAAA,MAAM,MAAM,QAAQ;AACjC,qBAAe,QAAQ;AACvB,mBAAa,OAAO,WAAW;AAC/B,mBAAa,OAAO,WAAW;AAC/B,mBAAa,QAAQ,YAAY;AACjC,mBAAa,QAAQ,YAAY;AAAA,IACnC;AAEA,aAAS,YAAY;AACnB,YAAM,eAAe;AACrB,UAAI,CAAC,cAAc;AACjB;AAAA,MACF;AACA,mBAAa,KAAK;AACd,UAAA,MAAM,YAAY,SAAS,MAAM;AAC7B,cAAA,kBAAkB,MAAM,YAAY,EAAE;AAAA,MAC9C;AAAA,IACF;AAEA,aAAS,YAAY;AACnB,YAAM,eAAe;AACrB,UAAI,CAAC,cAAc;AACjB;AAAA,MACF;AACI,UAAA;AAEF,qBAAa,KAAK;AAAA,MAAA,QACZ;AAAA,MAER;AAAA,IACF;AAEA,aAAS,cAAc;AACrB,qBAAe,QAAQ;AAAA,IACzB;AAEA,aAAS,cAAc;AACrB,qBAAe,QAAQ;AAAA,IACzB;AAEA,aAAS,eAAe;AACtB,qBAAe,QAAQ;AAAA,IACzB;AAEA,aAAS,eAAe;AAClBA,oBAAAA,MAAA,MAAM,QAAO,sIAAqI,oBAAoB;AAAA,IAC5K;AAEA,aAAS,WAAsC;AACtC,aAAA,SAAS,IAAI,OAAO;AAAA,IAC7B;;;;;;;;;;;;;;;;;;ACnKA,GAAG,gBAAgB,SAAS;"}