{"version":3,"file":"message-input-audio-uniapp.js","sources":["pages-ai-desk/ai-desk-customer-uniapp/components/CustomerServiceChat/message-input/message-input-audio-uniapp.vue","E:/HBuilderX/plugins/uniapp-cli-vite/uniComponent:/RDovSkFWQUVFL215ZmxpZXMvdW5pYXBwLWFwcC91bmlhcHAvcGFnZXMtYWktZGVzay9haS1kZXNrLWN1c3RvbWVyLXVuaWFwcC9jb21wb25lbnRzL0N1c3RvbWVyU2VydmljZUNoYXQvbWVzc2FnZS1pbnB1dC9tZXNzYWdlLWlucHV0LWF1ZGlvLXVuaWFwcC52dWU"],"sourcesContent":["<template>\n  <div\n    :class=\"{\n      'message-input-audio': true,\n      'message-input-audio-open': isAudioTouchBarShow,\n    }\"\n  >\n  <div class=\"audio-message-icon-container\">\n    <Icon\n      class=\"audio-message-icon\"\n      :file=\"props.isEnableAudio ? keyboardIcon:audioIcon\"\n      :size=\"'23px'\"\n      :hotAreaSize=\"'3px'\"\n      @onClick=\"switchAudio\"\n    />\n  </div>\n    \n    <view\n      v-if=\"props.isEnableAudio\"\n      class=\"audio-input-touch-bar\"\n      @touchstart=\"handleTouchStart\"\n      @longpress=\"handleLongPress\"\n      @touchmove=\"handleTouchMove\"\n      @touchend=\"handleTouchEnd\"\n    >\n      <span>{{ TUITranslateService.t(`TUIChat.${touchBarText}`) }}</span>\n\n      <view\n        v-if=\"isRecording\"\n         class=\"record-container\"\n      >\n      \n        <view class=\"audio-bubble-blue\">\n          <Icon\n              :file=\"willCancelBySlide?audioBubbleRed:audioBubbleBlue\"\n              width=\"160px\"\n              height=\"74px\"\n            />\n            <view class=\"loading\">\n              <view class=\"line1\"></view>\n              <view class=\"line3\"></view>\n              <view class=\"line2\"></view>\n              <view class=\"line4\"></view>\n              <view class=\"line1\"></view>\n              <view class=\"line3\"></view>\n              <view class=\"line4\"></view>\n              <view class=\"line1\"></view>\n              <view class=\"line2\"></view>\n              <view class=\"line1\"></view>\n              <view class=\"line4\"></view>\n              <view class=\"line3\"></view>\n            </view>\n        </view>\n          \n\n        <view class=\"modal-text\">\n            {{ TUITranslateService.t(`TUIChat.${modalText}`) }}\n        </view>\n        <Icon\n          class=\"audio-delete-icon\"\n          :file=\"willCancelBySlide? audioDeleteIcon:audioBeforeDeleteIcon\"\n          width=\"54px\"\n          height=\"54px\"\n        />\n        <Icon\n            class=\"audio-record-icon\"\n            width=\"16px\"\n            height=\"20px\"\n            :file=\"audioRecordIcon\"\n            \n          />\n        <view class=\"icon-container\">\n          \n        </view>\n      </view>\n    </view>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport vue from '../../../adapter-vue';\nimport {\n  TUIStore,\n  StoreName,\n  TUIChatService,\n  SendMessageParams,\n  IConversationModel,\n  TUITranslateService,\n} from '@tencentcloud/chat-uikit-engine';\nimport { TUIGlobal } from '@tencentcloud/universal-api';\nimport { throttle } from 'lodash';\nimport Icon from '../../common/Icon.vue';\nimport audioIcon from '../../../assets/audio-blue.png';\nimport keyboardIcon from '../../../assets/keyboard_icon.png';\nimport { Toast, TOAST_TYPE } from '../../common/Toast/index-uniapp';\nimport { isEnabledMessageReadReceiptGlobal } from '../../../utils/utils';\nimport { InputDisplayType } from '../../../interface';\nimport audioRecordIcon from '../../../assets/msg-audio.svg';\nimport audioBeforeDeleteIcon from '../../../assets/audio-before-delete.svg';\nimport audioDeleteIcon from '../../../assets/audio-delete.svg';\nimport audioBubbleBlue from '../../../assets/audio-bubble-blue.svg';\nimport audioBubbleRed from '../../../assets/audio-bubble-red.svg';\nconst { ref, onMounted, onUnmounted } = vue;\n\ninterface IProps {\n  isEnableAudio: boolean;\n}\n\ninterface IEmits {\n  (e: 'changeDisplayType', type: InputDisplayType): void;\n}\n\ninterface RecordResult {\n  tempFilePath: string;\n  duration?: number;\n  fileSize?: number;\n}\n\ntype TouchBarText = '按住说话' | '抬起发送' | '抬起取消';\ntype ModalText = '正在录音' | '继续上滑可取消' | '松开手指 取消发送';\n\nconst emits = defineEmits<IEmits>();\nconst props = withDefaults(defineProps<IProps>(), {\n  isEnableAudio: false,\n});\n\nlet recordTime: number = 0;\nlet isManualCancelBySlide = false;\nlet recordTimer: number | undefined;\nlet firstTouchPageY: number = -1;\nlet isFingerTouchingScreen = false;\nlet isFirstAuthrizedRecord = false;\nconst recorderManager = TUIGlobal?.getRecorderManager();\n\nconst isRecording = ref(false);\nconst touchBarText = ref<TouchBarText>('按住说话');\nconst modalText = ref<ModalText>('正在录音');\nconst isAudioTouchBarShow = ref<boolean>(false);\nconst currentConversation = ref<IConversationModel>();\nconst willCancelBySlide = ref(false);\n\nconst recordConfig = {\n  // Duration of the recording, in ms, with a maximum value of 600000 (10 minutes)\n  duration: 60000,\n  // Sampling rate\n  sampleRate: 44100,\n  // Number of recording channels\n  numberOfChannels: 1,\n  // Encoding bit rate\n  encodeBitRate: 192000,\n  // Audio format\n  // Select this format to create audio messages that can be interoperable across all chat platforms (Android, iOS, WeChat Mini Programs, and Web).\n  format: 'mp3',\n};\n\nfunction switchAudio() {\n  emits('changeDisplayType', props.isEnableAudio ? 'editor' : 'audio');\n}\n\n\nonMounted(() => {\n  // Register events for the audio recording manager\n  recorderManager.onStart(onRecorderStart);\n  recorderManager.onStop(onRecorderStop);\n  recorderManager.onError(onRecorderError);\n\n  TUIStore.watch(StoreName.CONV, {\n    currentConversation: onCurrentConverstaionUpdated,\n  });\n});\n\nonUnmounted(() => {\n  TUIStore.unwatch(StoreName.CONV, {\n    currentConversation: onCurrentConverstaionUpdated,\n  });\n});\n\nfunction onCurrentConverstaionUpdated(conversation: IConversationModel) {\n  currentConversation.value = conversation;\n}\n\nfunction initRecorder() {\n  initRecorderData();\n  initRecorderView();\n}\n\nfunction initRecorderView() {\n  isRecording.value = false;\n  touchBarText.value = '按住说话';\n  modalText.value = '正在录音';\n}\n\nfunction initRecorderData(options?: { hasError: boolean }) {\n  clearInterval(recordTimer);\n  recordTimer = undefined;\n  recordTime = 0;\n  firstTouchPageY = -1;\n  isManualCancelBySlide = false;\n  if (!options?.hasError) {\n    recorderManager.stop();\n  }\n}\n\nfunction handleTouchStart() {\n  if (isFingerTouchingScreen) {\n    // Compatibility: Ignore the recording generated by the user's first authorization on the APP.\n    isFirstAuthrizedRecord = true;\n  }\n}\n\nfunction handleLongPress() {\n  isFingerTouchingScreen = true;\n  recorderManager.start(recordConfig);\n}\n\nconst handleTouchMove = throttle(function (e) {\n  if (isRecording.value) {\n    const pageY = e.changedTouches[e.changedTouches.length - 1].pageY;\n    if (firstTouchPageY < 0) {\n      firstTouchPageY = pageY;\n    }\n    const offset = (firstTouchPageY as number) - pageY;\n    if (offset > 110) {\n      touchBarText.value = '抬起取消';\n      modalText.value = '松开手指 取消发送';\n      isManualCancelBySlide = true;\n      willCancelBySlide.value = true;\n    } else if (offset > 50) {\n      touchBarText.value = '抬起发送';\n      modalText.value = '继续上滑可取消';\n      isManualCancelBySlide = false;\n      willCancelBySlide.value = false;\n    } else {\n      touchBarText.value = '抬起发送';\n      modalText.value = '正在录音';\n      isManualCancelBySlide = false;\n      willCancelBySlide.value = false;\n    }\n  }\n}, 100);\n\nfunction handleTouchEnd() {\n  isFingerTouchingScreen = false;\n  recorderManager.stop();\n}\n\nfunction onRecorderStart() {\n  if (!isFingerTouchingScreen) {\n    // If recording starts but the finger leaves the screen,\n    // it means that the initial authorization popup interrupted the recording and it should be ignored.\n    isFirstAuthrizedRecord = true;\n    recorderManager.stop();\n    return;\n  }\n  recordTimer = setInterval(() => {\n    recordTime += 1;\n  }, 1000);\n  touchBarText.value = '抬起发送';\n  isRecording.value = true;\n}\n\nfunction onRecorderStop(res: RecordResult) {\n  if (isFirstAuthrizedRecord) {\n    // Compatibility: Ignore the recording generated by the user's first authorization on WeChat. This is not applicable to the APP.\n    isFirstAuthrizedRecord = false;\n    initRecorder();\n    return;\n  }\n  if (isManualCancelBySlide || !isRecording.value) {\n    initRecorder();\n    return;\n  }\n  clearInterval(recordTimer);\n  /**\n   * Compatible with uniapp for building apps\n   * Compatible with uniapp voice messages without duration\n   * Duration and fileSize need to be supplemented by the user\n   * File size = (Audio bitrate) * Length of time (in seconds) / 8\n   * res.tempFilePath stores the temporary path of the recorded audio file\n   */\n  const tempFilePath = res.tempFilePath;\n  const duration = res.duration ? res.duration : recordTime * 1000;\n  const fileSize = res.fileSize ? res.fileSize : ((48 * recordTime) / 8) * 1024;\n\n  if (duration < 1000) {\n    Toast({\n      message: '录音时间太短',\n      type: TOAST_TYPE.NORMAL,\n      duration: 1500,\n    });\n  } else {\n    const options = {\n      to:\n        currentConversation?.value?.groupProfile?.groupID\n        || currentConversation?.value?.userProfile?.userID,\n      conversationType: currentConversation?.value?.type,\n      payload: { file: { duration, tempFilePath, fileSize } },\n      needReadReceipt: isEnabledMessageReadReceiptGlobal(),\n    } as SendMessageParams;\n    TUIChatService?.sendAudioMessage(options);\n  }\n  initRecorder();\n}\n\nfunction onRecorderError() {\n  initRecorderData({ hasError: true });\n  initRecorderView();\n}\n</script>\n\n<style lang=\"scss\" scoped>\n@import \"../style/common\";\n\n@keyframes voiceBar {\n  from,\n  10%{\n    height:10rpx;\n  }\n  to,\n  90%{\n    height:50rpx;\n  }\n}\n\n.message-input-audio {\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n\n  .audio-message-icon-container{\n    background-color: #fff;\n    padding: 3px;\n    margin-right: 10px;\n    border-radius: 10px;\n  }\n\n  .audio-message-icon {\n  }\n\n  .audio-input-touch-bar {\n    height: 39px;\n    flex: 1;\n    border-radius: 10px 0 0 10px;\n    display: flex;\n    flex-direction: row;\n    justify-content: center;\n    align-items: center;\n    background-color: #fff;\n\n    .record-container{\n      height:60vh;\n      width: 100vw;\n      position:fixed;\n      overflow: hidden;\n      right: 0;\n      bottom: 0;\n      background: linear-gradient(to top, rgba(255, 255, 255, 1) 70%, rgba(255, 255, 255, 0));\n      .audio-record-icon{\n        position:absolute;\n        bottom:50px;\n        left: 50%;\n        transform: translateX(-50%);\n        z-index:2;\n      }\n      .audio-delete-icon{\n        position:absolute;\n        bottom:32%;\n        left: 50%;\n        transform: translateX(-50%);\n        z-index: 2;\n      }\n      .icon-container{\n        position: absolute;\n        bottom: -183%;\n        left: -70%;\n        width: 950px;\n        height: 950px;\n        border-radius: 50%;\n        background: linear-gradient(180deg, #E8EDF3 -1.18%, #FBFBFB 4.94%);\n        box-shadow: 0px -7.5px 5px 0px rgba(218, 224, 232, 0.15);\n      }\n      .modal-text{\n        position:absolute;\n        top:43%;\n        left: 50%;\n        transform: translateX(-50%);\n        color:#4E5461;\n        \n      }\n      .audio-bubble-blue{\n        position:absolute;\n        top:20%;\n        left: 50%;\n        transform: translateX(-50%);\n        .loading{\n          position:absolute;\n          top:35rpx;\n          left:25rpx;\n        }\n        .loading>view {\n          display:inline-block;\n          vertical-align: middle;\n          width: 8rpx;\n          background-color: #fff;\n          margin-right: 16rpx;\n          border-radius: 50rpx;\n        }\n        .line1 {\n          animation: voiceBar 0.6s infinite ease-in-out alternate;\n        }\n        .line2 {\n          animation: voiceBar 0.4s infinite ease-in-out alternate;\n        }\n        .line3 {\n          animation: voiceBar 0.5s infinite ease-in-out alternate;\n        }\n        .line4 {\n          animation: voiceBar 0.3s infinite ease-in-out alternate;\n        }\n      }\n    }\n\n    .record-modal {\n      height: 300rpx;\n      width: 60vw;\n      background-color: rgba(0, 0, 0, 0.8);\n      position: fixed;\n      left: 50%;\n      top: 50%;\n      transform: translate(-50%, -50%);\n      z-index: 9999;\n      border-radius: 24rpx;\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n\n      .red-mask {\n        position: absolute;\n        inset: 0;\n        background-color: rgba(#ff3e48, 0.5);\n        opacity: 0;\n        transition: opacity 10ms linear;\n        z-index: 1;\n      }\n\n      .moving-slider {\n        margin: 10vw;\n        width: 40rpx;\n        height: 16rpx;\n        border-radius: 4rpx;\n        background-color: #006fff;\n        animation: loading 1s ease-in-out infinite alternate;\n        z-index: 2;\n      }\n\n      .float-element {\n        position: relative;\n        z-index: 2;\n      }\n    }\n\n    @keyframes loading {\n      0% {\n        transform: translate(0, 0);\n      }\n\n      100% {\n        transform: translate(30vw, 0);\n        background-color: #f5634a;\n        width: 40px;\n      }\n    }\n\n    .modal-title {\n      text-align: center;\n      color: #fff;\n    }\n  }\n\n  &-open {\n    flex: 1;\n  }\n}\n</style>\n","import Component from 'D:/JAVAEE/myflies/uniapp-app/uniapp/pages-ai-desk/ai-desk-customer-uniapp/components/CustomerServiceChat/message-input/message-input-audio-uniapp.vue'\nwx.createComponent(Component)"],"names":["vue","TUIGlobal","TUIStore","StoreName","throttle","Toast","TOAST_TYPE","_a","isEnabledMessageReadReceiptGlobal","TUIChatService"],"mappings":"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"}